define("widget/img_loader",["lib/zepto","business/jsbridge","zepto","business/common","business/router","piggy/util/cookie","piggy/util/cacheData","piggy/util/tpl","piggy/util/uri","piggy/util/report"],function(a,b,c){
function d(a){var b=this;this.attr=a.attr,m._options||(m._options=a,m._idleNum=a.max),a&&a.bottom||f.invoke("mqq.device.getNetworkType",function(a){i.one("touchstart.changebt",function(){m._options.bottom=document.documentElement.clientHeight*(1!==a?2:3),
b.sort().loadNext()})})}var e=a("lib/zepto"),f=a("business/jsbridge"),g=a("business/common"),h=e("body"),i=e(window),j={},k={},l={attr:"data-url",bottom:document.documentElement.clientHeight,top:document.documentElement.clientHeight,
max:6,_idleNum:6,debug:!1,auto:!1};j.getInstance=function(a){var b=e.extend({},l,a),c=b.attr,f=k[c];return f?f:k[c]=new d(b)};var m=d.prototype={_container:h,_imgList:[],_event:{},compile:function(a){var b=this,c=b._isLoadOver();
return b._container=a||b._container,a&&e(b._container).find("["+b.attr+"]").each(function(a,c){var d=e(c),f=d.attr(b.attr);d.removeAttr(b.attr),f&&b._imgList.push({$el:d,url:f})}),b._imgList.forEach(function(a){
a.offset=a.$el.offset()}),b._imgList.length&&(b.sort().loadNext(),c&&b._bindEvent()),this},sort:function(){if(!this._imgList.length)return this;var a=this,b=i.scrollTop(),c=document.documentElement.clientHeight;
return a._imgList.forEach(function(d,e){var f=d.offset;a._isVisible(d,b,c)?d.index=6e6-f.top:a._isBottom(d,b,c)?d.index=5e6-f.top:a._isTop(d,b,c)?d.index=3e6+f.top:a._isDown(d,b)?d.index=3e6-f.top:a._isHidden(d)?d.index=f.top:d.index=1e6+f.top;
}),a._imgList.sort(function(a,b){return b.index-a.index||a.offset.left-b.offset.left}),this},loadNext:function(){var a=this,b=this._idleNum;return!a._imgList.length||0>=b?this:(m._imgList=m._imgList.filter(function(c){
return 0>=b||c.index<1e6||c.index<=3e6&&(!m._options.auto||c.isError)?c:(a._log("加载图片:",c.$el[0]),a._loadImg(c),void b--)}),this)},_loadImg:function(a){var b=this,c=new Image;return m._idleNum--,c.onload=function(){
m._idleNum++,b._onload(a)},c.onerror=function(c){m._idleNum++,b._onerror(a)},a.url=g.getCDNStaticUrl(a.url),c.src=a.url,this},_onload:function(a){this._log("加载成功:",a.$el[0]),a.$el.css("background-image",'url("'+a.url+'")'),
this.loadNext().trigger("load",a),this._isLoadOver()&&this._unbindEvent()},_onerror:function(a){a.isError=!0,a.index=0,this._imgList.push(a),this.trigger("error",a).loadNext()},_bindEvent:function(){var a,b,c=this;
return i.on("scroll.imgLoader",function(){a&&clearTimeout(a),a=setTimeout(function(){a=null,c.sort().loadNext()},30)}).on("touchend.loaderStart",function(){c.sort().loadNext(),a&&clearTimeout(a),b&&clearTimeout(b),
b=setTimeout(function(){b=null,c.compile()},500)}),this},_unbindEvent:function(){return i.off("scroll.imgLoader touchend.loaderStart"),this},_isVisible:function(a,b,c){var d=a.offset;return d.height&&d.width&&b+c>d.top&&d.top+d.height>=b;
},_isTop:function(a,b,c){var d=a.offset,e=d.top+d.height;return b>e&&b-m._options.top<e},_isBottom:function(a,b,c){var d=a.offset;return d.top>b+c&&d.top<b+c+m._options.bottom},_isDown:function(a,b){var c=a.offset;
return c.height&&c.width&&c.top>=b},_isHidden:function(a){var b=a.offset;return!b.height||!b.width},_isLoadOver:function(){return!this._imgList.length&&m._idleNum==m._options.max},_log:function(a,b){m._options.debug&&console.log(a,b);
},on:function(a,b){return this._event[a]=b,this},trigger:function(a,b){var c=this._event[a];return c&&setTimeout(function(){c(b)}),this}};c.exports={ImgLoader:d,getInstance:function(a){return j.getInstance(a);
}}});