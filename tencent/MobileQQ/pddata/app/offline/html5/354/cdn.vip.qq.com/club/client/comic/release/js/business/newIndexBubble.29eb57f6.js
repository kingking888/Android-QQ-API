define("business/newIndexBubble",["lib/zepto","piggy/util/tpl","business/common","zepto","business/router","piggy/util/cookie","business/jsbridge","piggy/util/cacheData","piggy/util/uri","piggy/util/report","business/comic","piggy/util/process","piggy/util/string","widget/WVUtil","piggy/util/net","business/security"],function(a,b,c){
var d=a("lib/zepto"),e=a("piggy/util/tpl"),f=a("business/common"),g=a("business/comic"),h=a("business/security"),i=a("business/router"),j=a("piggy/util/cacheData"),k=a("piggy/util/net"),l=(a("piggy/util/uri"),
a("business/jsbridge"),{}),m=window.location.protocol+"//h5.vip.qq.com/p/red/cgi-bin/srfentry.fcgi",n='<section class="mod-reddot comic-newstips-wrap" data-tab="<%= data.tab %>" data-id="<%= data.id ? data.id : \'\' %>" data-link="<%= data.link ? data.link : \'\' %>"><div class="ui-newstips-wrap"><div class="ui-newstips comic-newstips"><span class="ui-avatar-tiled"><span class="comic-newstips-thumb" style="background-image:url(<%= data.img %>)"></span></span><div class="content"><span><%= data.content %></span></div><span class="ui-reddot ui-reddot-static" <%= data.redpoint ? \'\' : \'style="display: none;"\' %>></span></div></div></section>',o={
SET_DISPLAYED:"15",SET_CLICKED:"16"},p={comic:101,video:141,playershow:152};l.path=(f.iOS,"100800"),l.escapeHtml=function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"
};return String(a).replace(/[&<>"'\/]/g,function(a){return b[a]})},b.init=function(a){function b(a){var b,c,e,f,g,h,k,m=l.redpointList={};if(a&&a.msg){var n="";for(a=a.msg,b=Object.keys(a),h=0,k=b.length;k>h;h++){
e=a[b[h]];try{c="string"==typeof e.content?JSON.parse(e.content):e.content}catch(p){continue}if(n=j.get(i.getUserId()+"index_bubble_clicked_"+b[h])){l.setRedpointInfo(l.path,o.SET_CLICKED,[{id:String(b[h]),
stat:"2"}]);try{n=JSON.parse(n),l.compassReport&&l.compassReport.send({obj_id:"10064",oper_obj_type:"2",oper_obj_id:200253,ret_id:n.id||0})}catch(p){}}else c.type&&"bubble"!=c.type||(f=m[c.tab],g={id:b[h],
page:c.page||"index",tab:c.tab||"comic",priority:Number(c.priority)||1,redpoint:c.redpoint||!0,content:l.escapeHtml(c.content),img:c.img||"",link:encodeURI(c.link)||"",time:Number(a[b[h]].time)||0},c.from&&-1===c.from.split(/[\s,]+/).join(",").replace(/(^,)|(,$)/,"").split(",").indexOf(String(l.fromSource))||(m[c.tab]=l.filterPriority(f,g)?f:g));
}var q=[];q.push("tab_btn1");var r=l.tabList={};r.comic=1;var s;for(s in r)r.hasOwnProperty(s)&&(m.all&&(f=m[s],g=d.extend({},m.all,{tab:s}),m[s]=l.filterPriority(f,g)?f:g),m[s]&&(m[s].index=r[s]));delete m.all;
var t,u=[];for(t in m)m.hasOwnProperty(t)&&u.push({id:String(m[t].id),stat:"1"});u.length>0?l.renderIndexBubble(l.filterMatch(m,1,"index")):l.compassReport&&l.compassReport.send({obj_id:"10064",oper_obj_type:"3",
oper_obj_id:300032,ses_id:"2",ret_id:0})}}arguments.callee;l.observer=a.observer,l.compassReport=a.compassReport,l.urlParams=a.params,l.fromSource="undefined"==typeof l.urlParams._cfrom?l.urlParams.from:l.urlParams._cfrom,
l.getRedpointInfo(l.path,function(a){b(a)}),l.initEvents()},l.initEvents=function(){var a=d("#index_wrap");a.on("click",".comic-newstips-wrap",function(a){var b,c=d(this),e=c.attr("data-id"),f=c.attr("data-tab"),h=c.attr("data-link"),k=!0;
if("undefined"!=typeof e){for(;k;)b=l.filterMatch(l.redpointList,e,"id"),k="undefined"!=typeof b,k&&delete l.redpointList[b.tab];l.setRedpointInfo(l.path,o.SET_CLICKED,[{id:String(e),stat:"2"}]),l.compassReport&&l.compassReport.send({
obj_id:"10064",oper_obj_type:"2",oper_obj_id:200253,ret_id:e||0}),j.set(i.getUserId()+"index_bubble_clicked_"+e,JSON.stringify({page_id:p[f]||0,id:e||0})),c.remove(),setTimeout(function(){g.handleUrl(h);
},0)}})},l.filterMatch=function(a,b,c){for(var d,e,f=Object.keys(a),g=0,h=f.length;h>g;g++)if(e=a[f[g]],"undefined"!=typeof c){if(e[c]==b){d=e;break}}else if(a[e]==b){d=e;break}return d},l.renderIndexBubble=function(a){
var b,c=d("#index_wrap");return b=a&&j.get(i.getUserId()+"index_bubble_displayed_"+a.tab+"_"+a.id),a&&"displayed"!=b&&j.set(i.getUserId()+"index_bubble_displayed_"+a.tab+"_"+a.id,"displayed"),a?(0==d(".comic-newstips-wrap",c).length?d("#enter_wrap").after(e.get(n,{
data:a})):d(".comic-newstips-wrap",c).replaceWith(e.get(n,{data:a})),void(l.compassReport&&l.compassReport.send({obj_id:"10064",oper_obj_type:"3",oper_obj_id:300032,ses_id:"1",ret_id:a.id||0}))):void d(".comic-newstips-wrap",c).remove();
},l.filterPriority=function(a,b){return a&&b?a.priority<b.priority?!1:a.priority==b.priority&&a.time<=b.time?!1:!0:!1},l.setRedpointInfo=function(a,b,c){var d={cmd:String(b),uin:i.getUserId(),platid:f.iOS?"110":"109",
qqver:f.QQVersion||"",osver:"",appid:a,ret:"0",type:"0",isred:"0",set:"0",mission:c},e={10337:{sReq:JSON.stringify(d)}};k.ajax({type:"POST",url:m+"?g_tk="+h.getCSRFToken(),dataType:"json",xhrFields:{withCredentials:!0
},data:JSON.stringify(e),timeout:6e4,success:function(){},error:function(){}})},l.getRedpointInfo=function(a,b){if("function"==typeof b){var c=m+"?g_tk="+h.getCSRFToken(),d=i.getUserId(),e={uin:String(d),
platid:f.iOS?"110":"109",qqver:f.QQVersion||"",osver:"",type:"0",appid:a,noset:"1"},g={10359:{sReq:JSON.stringify(e)}};k.ajax({type:"POST",url:c,xhrFields:{withCredentials:!0},data:JSON.stringify(g),success:function(a){
var c;if("string"==typeof a)try{a=JSON.parse(a)}catch(d){a=null}if(a&&0==a.ecode)try{c=a[10359].data.sRsp,c="string"==typeof c?JSON.parse(c):c,0==c.ecode?(c="string"==typeof c.msg?JSON.parse(c.msg):c.msg,
b(c)):l.compassReport&&l.compassReport.send({obj_id:"10064",oper_obj_type:"3",oper_obj_id:300032,ses_id:"2",ret_id:0})}catch(d){console.log(d)}},error:function(){}})}},l.getRedpointInstance=function(b){
var c=arguments.callee;c.redpoint?b(c.redpoint):a.async("widget/redpoint",function(a){a&&a.queryDyanmicStatus&&(c.redpoint=a,b(c.redpoint))})}});