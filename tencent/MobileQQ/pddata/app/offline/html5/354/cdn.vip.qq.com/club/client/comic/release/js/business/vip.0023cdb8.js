define("business/vip",["lib/zepto","business/common","zepto","business/router","piggy/util/cookie","business/jsbridge","piggy/util/cacheData","piggy/util/tpl","piggy/util/uri","piggy/util/report","piggy/util/process","piggy/util/string","piggy/util/net"],function(a,b,c){
var d=a("lib/zepto"),e=a("business/common"),f=a("piggy/util/cacheData"),g=a("piggy/util/process"),h=(a("piggy/util/string"),a("business/jsbridge")),i=a("business/router"),j=(a("piggy/util/tpl"),a("piggy/util/net"),
a("piggy/util/cookie"),{});j.dialogTpl='<div class="ui-loading-block show" id="<%=id%>"><div class="ui-loading-cnt"><i class="ui-loading-bright"></i><p><%=content%></p></div></div>',b.getVipInfoBanner=function(a,b,c,d){
var h=3600,j=3600;return f.getWithListStruct(a,["getCommonBanner"],a.id?a.id:(new Date).getTime(),function(a,b,c,d){g.lockNext("getCommonBanner","comic/getCommonBanner",function(a){c(a&&0==a.result&&a.data?{
result:0,data:{getCommonBanner:a.data}}:a)},function(a){e.sendMergeRequest({url:i.createNewUrl("vpcm/cgi-bin/coupon_coin"),data:{module:"comic",method:"getCommonBanner",param:b},callback:function(b){a(b);
}})})},function(a){a&&a.data&&a.data.getCommonBanner&&(a.data=a.data.getCommonBanner),b(a)},"undefined"==typeof c||null===c?h:c,"undefined"==typeof d||null===d?j:d)},b.getIOSPayItem=function(){return[{
openMonth:12,couponCount:12,productId:"com.tencent.mqq.dongmanvip.nonrenewing.12months",price:118},{openMonth:3,couponCount:3,productId:"com.tencent.mqq.dongmanvip.nonrenewing.3months",price:30},{openMonth:6,
couponCount:6,productId:"com.tencent.mqq.dongmanvip.nonrenewing.6months",price:60},{openMonth:1,couponCount:1,productId:"com.tencent.mqq.dongmanvip.nonrenewing.1months",price:12}]},b.getVipPriceList=function(a,b){
function c(a){var c=604800,d=86400;return f.getWithListStruct({},["vipPriceList"],["comic/vipPriceList",i.getUserId()].join("_"),function(b,c,d){g.lockNext("vipPriceList","comic/vipPriceList",function(a){
d(a&&0==a.result&&a.data?{result:0,data:{vipPriceList:a.data}}:a)},function(b){e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/coupon_coin"),data:{module:"comic_user_base_info",method:"getComicVipPriceList",
param:{type:a||0}},callback:function(a){b(a)}})})},function(a){a&&a.data&&a.data.vipPriceList&&(a.data=a.data.vipPriceList),b(a)},"undefined"==typeof expire||null===expire?c:expire,"undefined"==typeof update||null===update?d:update);
}var d=this;e.iOS?b({result:0,data:{list:d.getIOSPayItem(),isIap:!0}}):c(e.android&&e.compareVersion(e.QQVersion,"6.2.0")>=0?1:2)},b.getComicVipStatus=function(a,b){e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/coupon_coin"),
data:{module:"comic_user_base_info",method:"getComicVipStatus",param:{}},callback:function(a){b(a)}})},b.getComicUserInfo=function(a,b,c){var d=3600;return f.getWithListStruct({},["comicUserInfo"],["comic/comicUserInfo",i.getUserId()].join("_"),function(a,b,c){
g.lockNext("comicUserInfo","comic/comicUserInfo",function(a){c(a&&0==a.result&&a.data?{result:0,data:{comicUserInfo:a.data}}:a)},function(a){e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/comic_common_asyn_cgi"),
data:{module:"comic_user_base_info",method:"getBasicUserInfo",param:{}},callback:function(b){a(b)}})})},function(a){a&&a.data&&a.data.comicUserInfo&&(a.data=a.data.comicUserInfo),b(a)},"undefined"==typeof c||null===c?d:c);
},b.openVip=function(b,c){if(e.iOS)h.invoke("mqq.pay.pay",{apple_pay_source:"qq_comic",qq_product_id:0,qq_product_name:"动漫会员",app_id:"1450006099",pf:"qq_m_qq-1-iap-1-"+b.aid,pfkey:"pfKey",product_id:b.productId,
product_type:4,quantity:1,is_deposit_game_coin:0,pay_item:String(b.couponCount),var_item:"qq_comic"},function(a){c&&c({result:a})});else if(e.android&&e.compareVersion(e.QQVersion,"6.2.0")>=0){var f={offerId:"1450005513",
userId:i.getUserId(),serviceCode:"MHVIP1",serviceName:"动漫VIP",channel:b.channel||"",unit:b.unit||"月",isCanChange:b.isCanChange||!1,aid:b.aid||"",autoPay:d("#autoOpenVip").attr("checked"),remark:b.remark||"",
productId:b.productId||"",saveValue:b.saveValue||1,isShowNum:b.isShowNum||!1,pf:"qq_m_qq-1-android-1-"+b.aid};h.invoke("mqq.pay.subscribeMonthCardPay",f,function(a){a&&"undefined"!=typeof a.resultCode?(a.result=a.resultCode,
delete a.resultCode):a.result=-2,c&&c(a)})}else a.async("midas",function(a){Midas&&Midas.openSubscribe({appid:"1450007502",service:"MHVIP1",pf:"qq_m_qq-1-iap-1-"+(b.aid||"default"),account:"qq",sandbox:!1,
aid:b.aid,ap:d("#autoOpenVip").size()&&d("#autoOpenVip").attr("checked")?1:0,productid:b.productId||"",as:1,onSuccess:function(){c&&c({result:0})},onClose:function(){c&&c({result:2})}})})},b.getComicIdsByCategory=function(a,b,c,d){
var h=3600,j=60;return f.getWithListStruct({},["comicLimitList"],"comic/comicLimitList",function(a,b,c){g.lockNext("comicLimitList","comic/comicLimitList",function(a){c(a&&0==a.result&&a.data?{result:0,
data:{comicLimitList:a.data}}:a)},function(a){e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/coupon_coin"),data:{module:"comic_user_base_info",method:"getComicVipLimitFreeList",param:{}},callback:function(b){
a(b)}})})},function(a){a&&a.data&&a.data.comicLimitList&&(a.data=a.data.comicLimitList),b(a)},"undefined"==typeof c||null===c?h:c,"undefined"==typeof d||null===d?j:d)},b.getComicVipReadStatus=function(a,b){
a.comicID=String(a.comicID),h.invoke("mqq.comic.getComicVipStatus",a,function(a){a&&(a.result=a.code,delete a.code,b&&b(a))})},b.getComicVipOpenResult=function(a,b){function c(){return f.count>=6?(d.getComicVipReadStatus(a,b),
f.count=0,!1):void e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/comic_common_asyn_cgi"),data:{module:"comic_user_base_info",method:"getBasicUserInfo",param:{}},callback:function(e){e&&0==e.result&&e.data?8&e.data.vipType?d.getComicVipReadStatus(a,b):(f.count++,
setTimeout(c,500)):d.getComicVipReadStatus(a,b)}})}var d=this,f=arguments.callee;"undefined"==typeof f.count&&(f.count=0),c()},b.getComicVipSuccessStatus=function(a,b){function c(){return d.count>=6?(b(),
d.count=0,!1):void e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/coupon_coin"),data:{module:"comic_user_base_info",method:"getComicVipStatus",param:{}},callback:function(e){e&&0==e.result&&e.data?e.data.comicVipExpireTime>a.comicVipExpireTime?b(e.data):(d.count++,
setTimeout(c,500)):b()}})}var d=arguments.callee;"undefined"==typeof d.count&&(d.count=0),c()},b.getVipStatusByExpire=function(a,b){var c={comicVipTips:a.comicVipTips};0===a.comicVipExpireTime?(c.vipType=0,
b(c)):e.getNowTime(function(d){var f;f=a.comicVipExpireTime-Math.floor(d/1e3),0>=f&&(c.vipType=3),f>0&&1296e3>f&&(c.vipType=2,c.expireTime=Math.floor(f/86400)),f>=1296e3&&(c.vipType=1,c.expireTime=e.getDateFormat(1e3*a.comicVipExpireTime,"YYYY-MM-DD")),
b(c)})},b.preloadSmartPayWV=function(){j.smartPayWV||e.asyncLoadInstance("lib/pay/smartpay.proxywv",function(a){window.proxywv&&proxywv.openService&&(j.smartPayWV=!0)})},b.openSVIPWV=function(a,c){var d=arguments.callee,a=a||{},f="!svip";
j.smartPayWV?proxywv.openService({month:3,type:f,isAutoPay:!0,aid:a.aid||"mvip.gongneng.mobileqq.comic.open.web"},function(a){a&&0==a.ret?(c(a),setTimeout(function(){b.getVipInfoAndOpenType&&b.getVipInfoAndOpenType({},function(a){},!0);
},1e3)):a&&2==a.ret}):e.asyncLoadInstance("lib/pay/smartpay.proxywv",function(b){proxywv&&proxywv.openService&&(j.smartPayWV=!0,d.call(d,a,c))})},b.openSvip=function(a,c){var d=arguments.callee,a=a||{},f="!svip";
j.smartpay?qw.smartPay.openService({data:{uin:i.getUserId(),is_club:!1,is_superclub:!1},month:3,type:f,isAutoPay:!0,aid:a.aid||"mvip.gongneng.mobileqq.comic.open.web",onPayCallback:function(a){a&&0==a.ret?(c(a),
setTimeout(function(){b.getVipInfoAndOpenType&&b.getVipInfoAndOpenType({},function(a){},!0)},1e3)):a&&2==a.ret}}):e.asyncLoadInstance("lib/smartpay",function(b){qw&&qw.smartPay&&(j.smartpay=!0,d.call(d,a,c));
})},b.getVipShowType=function(a,b,c){var d=86400;return f.getWithListStruct({},["vipShowType"],["comic/vipShowType",i.getUserId()].join("_"),function(a,b,c){g.lockNext("vipShowType","comic/vipShowType",function(a){
c(a&&0==a.result&&a.data?{result:0,data:{vipShowType:a.data}}:a)},function(a){e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/coupon_coin"),data:{module:"comic_user_base_info",method:"getVipShowType",
param:{}},callback:function(b){a(b)}})})},function(a){a&&a.data&&a.data.vipShowType&&(a.data=a.data.vipShowType),b(a)},"undefined"==typeof c||null===c?d:c)},b.getVipStatus=function(a,b,c){var d=3600;return f.getWithListStruct({},["svipStatus"],["comic/svipStatus",i.getUserId()].join("_"),function(a,b,c){
g.lockNext("svipStatus","comic/svipStatus",function(a){c(a&&0==a.result&&a.data?{result:0,data:{svipStatus:a.data}}:a)},function(a){e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/coupon_coin"),data:{
module:"comic_user_base_info",method:"getVipStatus",param:{}},callback:function(b){a(b)}})})},function(a){a&&a.data&&a.data.svipStatus&&(a.data=a.data.svipStatus),b(a)},"undefined"==typeof c||null===c?d:c);
},b.getVipInfoAndOpenType=function(a,b,c){var d=this;d.getComicUserInfo({},function(a){a&&0==a.result&&a.data?8==a.data.vipType?(a.data.openType="comic",b(a)):d.getVipShowType({},function(c){c&&0==c.result&&c.data&&0==c.data.showType?(a.data.openType="comic",
b(a)):(a.data.openType="svip",b(a))}):b(a)},c)},b.getUserVideoVipInfo=function(a){e.sendMergeRequest({url:i.createUrl("vpcm/cgi-bin/comic_common_asyn_cgi"),data:{module:"community.PersonalPageMtServer.PersonalPageMtObj",
method:"getUserVideoVipInfo",param:{}},callback:function(b){"function"==typeof a&&a(b)}})},b.getUserVipInfo=function(a,b,c){var d=this;a=a||"comic","svip"==a?d.getVipStatus({},function(a){a&&0==a.result&&a.data?(a.data.discountStr=a.data.discount%10?a.data.discount:a.data.discount/10,
a.data.expireTime=a.data.svipExpireTime,b(a)):b(a)},c):d.getComicVipStatus({},function(a){a&&0==a.result&&a.data?(a.data.discountStr=a.data.comicVipDiscount%10?a.data.comicVipDiscount:a.data.comicVipDiscount/10,
a.data.expireTime=a.data.comicVipExpireTime,b(a)):b(a)})},b.getExpireTimeInfo=function(a,b){var c=a.expireTime||0,d=a.vipOpenType||"comic";e.getNowTime(function(f){var g,h={};if(g=c-Math.floor(f/1e3),0==c||-1296e3>g)h.text="svip"==d?"":"大爷，开个动漫VIP吧╥﹏╥…",
h.vipStatus=0==c?1:2;else if(0>g&&g>=-864e3)h.text="svip"==d?"超级会员已经过期啦╥﹏╥…":"过期啦，想念我吗╥﹏╥…",h.vipStatus=5;else if(g>0&&1296e3>g){var i,j=Math.floor(g/86400);i=0==j?"今天就过期啦 (⊙ˍ⊙)":1==j?"明天就过期啦 (⊙ˍ⊙)":"到期时间:<em>"+e.getDateFormat(1e3*c,"YYYY-MM-DD")+"</em>",
h.text=("svip"==d?"超级会员":"动漫VIP")+i,h.vipStatus=4}else if(g>1296e3){var k=!!a.emphasize;h.text=("svip"==d?"超级会员":"动漫VIP")+"到期时间:"+(k?"<em>":"")+e.getDateFormat(1e3*c,"YYYY-MM-DD")+(k?"<em>":""),h.vipStatus=3;
}b(h)})},b.getVipIconObj=function(a,b){var c="",d=!1;return"svip"==a?(4&b&&(d=!0),c="ui-icon-svip"+(d?"":"-off")):(8&b&&(d=!0),c="icon-comic-vip"+(d?"":" disabled")),{vipIconClass:c,isVip:d}},b.refreshComicVipCache=function(a){
f.set(i.getUserId()+"comicVip_refresh_flag",a)},b.getComicVipCache=function(){return f.get(i.getUserId()+"comicVip_refresh_flag")}});